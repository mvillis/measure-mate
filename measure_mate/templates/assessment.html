{% extends "base.html" %}

{% block title %}Measure Mate{% endblock %}
{% block head %}

{% endblock %}
{% block body %}
<div class="container">
<div id="content"></div>
</div>
<script type="text/jsx">
  var TemplateTable = React.createClass({
    loadAssessmentFromServer: function() {
      $.ajax({
        url: this.props.url,
        dataType: 'json',
        cache: false,
        success: function(data) {
          this.loadRatingsFromServer(data);
        }.bind(this),
        error: function(xhr, status, err) {
          console.error(this.props.url, status, err.toString());
        }.bind(this)
      });
    },
    loadRatingsFromServer: function(data) {
      $.ajax({
        url: '/api/templates/' + data.template.id + '/',
        dataType: 'json',
        cache: false,
        success: function(data) {
          this.setState({data: data.attributes, name: data.name, desc: data.desc});
        }.bind(this),
        error: function(xhr, status, err) {
          console.error(this.props.url, status, err.toString());
        }.bind(this)
      });
    },
    handleRatingSubmit: function(rating) {
      var ratings = this.state.data;
      var newRatings = ratings.concat([rating]);
      this.setState({data: newRatings});
      $.ajax({
        url: this.props.url,
        dataType: 'json',
        type: 'POST',
        data: rating,
        success: function(data) {
          this.setState({data: data.attributes, name: data.name, desc: data.desc});
        }.bind(this),
        error: function(xhr, status, err) {
          console.error(this.props.url, status, err.toString());
        }.bind(this)
      });
    },
    getInitialState: function() {
      return {data: []};
    },
    componentDidMount: function() {
      this.loadAssessmentFromServer();
      setInterval(this.loadAssessmentFromServer, this.props.pollInterval);
    },
    render: function() {
      return (
        <div className="TemplateTable">
          <div className="container">
            <div className="page-header">
              <h1>{this.state.name}<small> {this.state.desc}</small></h1>
            </div>
            <div className="panel panel-default">
              <div className="panel-heading">
                <h3 className="panel-title">{this.state.name}</h3>
              </div>
              <div className="panel-body">
                <AttributeList data={this.state.data} />
                <RatingForm onRatingSubmit={this.handleRatingSubmit}/>
              </div>
            </div>
          </div>
        </div>
      );
    }
    });

  var AttributeList = React.createClass({
    render: function() {
      var attributeNodes = this.props.data.map(function (attribute) {
        return (
          <RatingList key={attribute.id} name={attribute.name} desc={attribute.desc} data={attribute.ratings}>
            {attribute.ratings}
          </RatingList>
        );
      });
      return (
        <div className="AttributeList">
          {attributeNodes}
        </div>
      );
    }
  });

  var RatingForm = React.createClass({
    handleSubmit: function(e) {
      e.preventDefault();
      var author = React.findDOMNode(this.refs.author).value.trim();
      var text = React.findDOMNode(this.refs.text).value.trim();
      if (!text || !author) {
        return;
      }
      this.props.onRatingSubmit({author: author, text: text});
      React.findDOMNode(this.refs.author).value = '';
      React.findDOMNode(this.refs.text).value = '';
      return;
    },
    render: function() {
      return (
        <form className="ratingForm" onSubmit={this.handleSubmit}>
          <input type="text" placeholder="Your name" ref="author"/>
          <input type="text" placeholder="Say something..." ref="text"/>
          <input type="submit" value="Post" />
        </form>
      );
    }
  });

  // tutorial2.js
  var RatingList = React.createClass({
    render: function() {
      var ratingNodes = this.props.data.map(function (rating) {
        return (
          <Rating key={rating.id} name={rating.name} desc={rating.desc}>
            {rating}
          </Rating>
        );
      });
      return (
        <div className="list-group">
          <a href="#" className="list-group-item active">
            <h4 className="list-group-item-heading">{this.props.name}</h4>
            <p className="list-group-item-text">{this.props.desc}</p>
          </a>
          {ratingNodes}
        </div>
      );
    }
  });

  // tutorial4.js
  var Rating = React.createClass({
    render: function() {
      return (
        <a className="list-group-item">
          <h4 className="list-group-item-heading">{this.props.name}</h4>
          <pre className="list-group-item-text">{this.props.desc}</pre>
        </a>
      );
    }
  });

  React.render(
  <TemplateTable url="/api/assessments/{{id}}/" pollInterval={20000}/>,
  document.getElementById('content')
  );
</script>
{% endblock %}
