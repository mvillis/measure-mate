{% extends "base.html" %}

{% block title %}Measure Mate{% endblock %}
{% block head %}

{% endblock %}
{% block body %}
<div class="container">
<div id="content"></div>
</div>
<script type="text/babel">

  var Alert = ReactBootstrap.Alert;
  var PageHeader = ReactBootstrap.PageHeader;
  var ListGroup = ReactBootstrap.ListGroup;
  var ListGroupItem = ReactBootstrap.ListGroupItem;
  var Tabs = ReactBootstrap.Tabs;
  var Tab = ReactBootstrap.Tab;
  var Panel = ReactBootstrap.Panel;
  var Input = ReactBootstrap.Input;
  var Tooltip = ReactBootstrap.Tooltip;
  var OverlayTrigger = ReactBootstrap.OverlayTrigger;
  var Pager = ReactBootstrap.Pager;
  var PageItem = ReactBootstrap.PageItem;

  var TemplateTable = React.createClass({
    loadAssessmentFromServer: function() {
      $.ajax({
        url: this.props.url,
        dataType: 'json',
        cache: false,
        success: function(data) {
          this.loadRatingsFromServer(data);
        }.bind(this),
        error: function(xhr, status, err) {
          console.error(this.props.url, status, err.toString());
        }.bind(this)
      });
    },
    loadRatingsFromServer: function(assess_data) {
      $.ajax({
        url: '/api/templates/' + assess_data.template.id + '/',
        dataType: 'json',
        cache: false,
        success: function(data) {
          this.setState({assess_id: assess_data.id, data: data.attributes, name: data.name, desc: data.short_desc});
        }.bind(this),
        error: function(xhr, status, err) {
          console.error(this.props.url, status, err.toString());
        }.bind(this)
      });
    },
    handleRatingSubmit: function(rating) {
      var ratings = this.state.data;
      var newRatings = ratings.concat([rating]);
      this.setState({data: newRatings});
      $.ajax({
        url: this.props.url,
        dataType: 'json',
        type: 'POST',
        data: rating,
        success: function(data) {
          this.setState({data: data.attributes, name: data.name, desc: data.desc});
        }.bind(this),
        error: function(xhr, status, err) {
          console.error(this.props.url, status, err.toString());
        }.bind(this)
      });
    },
    getInitialState: function() {
      return {
        data: [],
        assess_id: null
      };
    },
    componentDidMount: function() {
      this.loadAssessmentFromServer();
      // setInterval(this.loadAssessmentFromServer, this.props.pollInterval);
    },
    render: function() {
      return (
          <div className="container">
            <PageHeader>
              {this.state.name} <small> {this.state.desc}</small>
            </PageHeader>
            <AttributeList assess_id={this.state.assess_id} data={this.state.data} />
          </div>
      );
    }
    });

  var AttributeList = React.createClass({
    getInitialState: function() {
      return {
        active_attribute: 1,
        rating_selected: false,
        measurements: null,
        next_hide: false,
        previous_hide: false
      };
    },
    componentWillReceiveProps: function(nextProps){
      this.dataSource(nextProps);
    },
    dataSource: function(props){
      props = props || this.props;

      return $.ajax({
        type: "get",
        dataType: 'json',
        url: '/api/measurements/' + '?assessment__id=' + props.assess_id
      }).done(function(result){
        this.setState({ measurements: result });
        this.handleTabChange(1);
      }.bind(this));
    },
    handleNext: function () {
      if (this.state.active_attribute < this.props.data.length && !this.state.next_hide) {
        var new_tab = this.state.active_attribute + 1;
        this.setState({active_attribute: new_tab});
        this.handleTabChange(new_tab);
      };
    },
    handlePrevious: function () {
      if (this.state.active_attribute !=1 && !this.state.previous_hide) {
        var new_tab = this.state.active_attribute - 1;
        this.setState({active_attribute: new_tab});
        this.handleTabChange(new_tab);
      }
    },
    handleSelect(key) {
      this.setState({active_attribute: key});
      this.handleTabChange(key);
    },
    handleTabChange: function (current_tab) {
      if (current_tab == 1) {
        this.setState({previous_hide: true});
      } else {
        this.setState({previous_hide: false});
      }
      if (current_tab >= this.props.data.length) {
        this.setState({next_hide: true});
      } else {
        this.setState({next_hide:false});
      }
    },
    getMeasurementForAttribute(attribute) {
      if (this.state.measurements != null) {
        for (var i = 0; i < this.state.measurements.length; i++) {
          if (attribute.id == this.state.measurements[i].rating.attribute) {
            return this.state.measurements[i];
            break;
          }
        };
      } else {
        return null;
      }
    },
    render: function() {
      var attributeNodes = this.props.data.map(function (attribute, i) {
        var measurement = this.getMeasurementForAttribute(attribute);
        return (
          <Tab eventKey={i+1} id={i+1} title={<div><span className="glyphicon glyphicon-chevron-right" aria-hidden="true"></span> <span>{attribute.name}</span></div>}>
            <RatingList key={attribute.id} measurement={measurement} attribute_id={attribute.id} assess_id={this.props.assess_id} name={attribute.name} desc={attribute.desc} desc_class={attribute.desc_class} data={attribute.ratings}/>
          </Tab>
        );
      }.bind(this));
      return (
        <div>
          <Tabs position="right" activeKey={this.state.active_attribute} onSelect={this.handleSelect} tabWidth={3}>
            {attributeNodes}
          </Tabs>
          <div className="col-xs-9">
            <Pager>
              <PageItem disabled={this.state.previous_hide} onClick={this.handlePrevious}>&larr; Previous</PageItem>
              {' '}
              <PageItem disabled={this.state.next_hide} onClick={this.handleNext}>Next &rarr;</PageItem>
            </Pager>
          </div>
          <div className="col-xs-3"/>
        </div>
      );
    }
  });

  var RatingList = React.createClass({
    getInitialState: function() {
      if (this.props.measurement) {
        return {
          measurement_id: this.props.measurement.id,
          selected_rating: this.props.measurement.rating.id
        };
      } else {
        return {
          measurement_id: null,
          selected_rating: null,
        };
      }
    },
    componentWillReceiveProps: function(newProps) {
      if (newProps.measurement && newProps.measurement.id != this.measurement_id) {
        this.setState({measurement_id: newProps.measurement.id,
                  selected_rating: newProps.measurement.rating.id});
      }
    },
    handleClick: function(data, e) {
      e.preventDefault();
      var create_new_measure = ((this.state.measurement_id == null) ? true : false);
      console.log('Should a new measurement be created? ' + create_new_measure)
      var postContent = data.postContent;
      var postData = {
        id: this.state.measurement_id,
        assessment: this.props.assess_id,
        rating: data,
        observations: "This is a dummy comment."
      };

      this.setState({ selected_rating: data });

      $.ajax({
        type: ((create_new_measure) ? "POST" : "PUT"),
        contentType: "application/json; charset=utf-8",
        url: ((create_new_measure) ? "/api/measurements/" : ("/api/measurements/" + this.state.measurement_id + '/')),
        data: JSON.stringify(postData),
        dataType: 'json',
        success: this.handleSubmitSuccess,
        error: this.handleSubmitFailure,
      });
    },

    handleComplete: function() {
      console.log("Hi, the complete button has been pushed");
      this.props.onComplete();
    },

    handleSubmitSuccess: function(data) {
      this.setState({
        selected_rating: data.rating,
        measurement_id: data.id
      });
    },

    handleSubmitFailure: function(xhr, ajaxOptions, thrownError) {
        console.error("There was a failure");
    },

    render: function() {
      var ratingNodes = this.props.data.map(function (rating) {
          var active = (this.state.selected_rating == rating.id)
          var desc_class = "rating-" + rating.name + (rating.desc_class ? " " + rating.desc_class : "")
          return (
            <ListGroupItem active={active} onClick={this.handleClick.bind(this, rating.id)} key={rating.id} header={rating.name} className={desc_class}>
              {rating.desc}
            </ListGroupItem>
          );
      }.bind(this));
      var desc_class = this.props.desc_class || ""
      return (
        <Panel header={this.props.name} bsStyle="primary">
          <p className={desc_class}>{this.props.desc}</p>
          <ListGroup fill>
            {ratingNodes}
          </ListGroup>
        </Panel>
      );
    }
  });

  React.render(
  <TemplateTable url="/api/assessments/{{id}}/" pollInterval={20000}/>,
  document.getElementById('content')
  );
</script>
{% endblock %}
