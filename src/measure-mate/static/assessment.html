<!-- index.html -->
<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Measure Mate</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/0.13.3/react.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/react/0.13.3/JSXTransformer.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/0.3.2/marked.min.js"></script>
        <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap.min.css">

    <!-- Optional theme -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/css/bootstrap-theme.min.css">

    <!-- Latest compiled and minified JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.5/js/bootstrap.min.js"></script>
  </head>
  <body>
    <nav class="navbar navbar-default">
      <div class="container-fluid">
        <!-- Brand and toggle get grouped for better mobile display -->
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1" aria-expanded="false">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <a class="navbar-brand" href="#">Measure Mate</a>
        </div>
      </div>
    </nav>
    <div id="content"></div>
    <script type="text/jsx">
      var TemplateTable = React.createClass({
        loadRatingsFromServer: function() {
          $.ajax({
            url: this.props.url,
            dataType: 'json',
            cache: false,
            success: function(data) {
              this.setState({data: data.attributes, name: data.name, short_desc: data.short_desc});
            }.bind(this),
            error: function(xhr, status, err) {
              console.error(this.props.url, status, err.toString());
            }.bind(this)
          });
        },
        handleRatingSubmit: function(rating) {
          var ratings = this.state.data;
          var newRatings = ratings.concat([rating]);
          this.setState({data: newRatings});
          $.ajax({
            url: this.props.url,
            dataType: 'json',
            type: 'POST',
            data: rating,
            success: function(data) {
              this.setState({data: data.attributes, name: data.name, short_desc: data.short_desc});
            }.bind(this),
            error: function(xhr, status, err) {
              console.error(this.props.url, status, err.toString());
            }.bind(this)
          });
        },
        getInitialState: function() {
          return {data: []};
        },
        componentDidMount: function() {
          this.loadRatingsFromServer();
          setInterval(this.loadRatingsFromServer, this.props.pollInterval);
        },
        render: function() {
          return (
            <div className="TemplateTable">
              <div className="container">
                <div className="page-header">
                  <h1>{this.state.name}<small> {this.state.short_desc}</small></h1>
                </div>
                <div className="panel panel-default">
                  <div className="panel-heading">
                    <h3 className="panel-title">{this.state.name}</h3>
                  </div>
                  <div className="panel-body">
                    <AttributeList data={this.state.data} />
                    <RatingForm onRatingSubmit={this.handleRatingSubmit}/>
                  </div>
                </div>
              </div>
            </div>
          );
        }
        });

      var AttributeList = React.createClass({
        render: function() {
          var attributeNodes = this.props.data.map(function (attribute) {
            return (
              <RatingList key={attribute.id} name={attribute.name} data={attribute.ratings}>
                {attribute.ratings}
              </RatingList>
            );
          });
          return (
            <div className="AttributeList">
              {attributeNodes}
            </div>
          );
        }
      });

      var RatingForm = React.createClass({
        handleSubmit: function(e) {
          e.preventDefault();
          var author = React.findDOMNode(this.refs.author).value.trim();
          var text = React.findDOMNode(this.refs.text).value.trim();
          if (!text || !author) {
            return;
          }
          this.props.onRatingSubmit({author: author, text: text});
          React.findDOMNode(this.refs.author).value = '';
          React.findDOMNode(this.refs.text).value = '';
          return;
        },
        render: function() {
          return (
            <form className="ratingForm" onSubmit={this.handleSubmit}>
              <input type="text" placeholder="Your name" ref="author"/>
              <input type="text" placeholder="Say something..." ref="text"/>
              <input type="submit" value="Post" />
            </form>
          );
        }
      });

      // tutorial2.js
      var RatingList = React.createClass({
        render: function() {
          var ratingNodes = this.props.data.map(function (rating) {
            return (
              <Rating key={rating.id} name={rating.name} desc={rating.desc}>
                {rating}
              </Rating>
            );
          });
          return (
            <div className="list-group">
              <a href="#" className="list-group-item active">
                <h4 className="list-group-item-heading">{this.props.name}</h4>
                <p className="list-group-item-text">{this.props.desc}</p>
              </a>
              {ratingNodes}
            </div>
          );
        }
      });

      // tutorial4.js
      var Rating = React.createClass({
        render: function() {
          var rawMarkup = marked(this.props.children.toString(), {sanitize: true});
          return (
            <a className="list-group-item">
              <h4 className="list-group-item-heading">{this.props.name}</h4>
              <p className="list-group-item-text">{this.props.desc}</p>
            </a>
          );
        }
      });

      React.render(
      <TemplateTable url="/api/templates/1/" pollInterval={20000}/>,
      document.getElementById('content')
      );
    </script>
  </body>
</html>
